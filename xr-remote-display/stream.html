<html>
  <head>
    <title>Stream</title>
  </head>
  <body>
    <button>Stream</button>
    <script type="module">
      const ws = import.meta.hot;
      /** @type {MediaStream} */
      let stream;
      /** @type {RTCPeerConnection} */
      let pc;
      async function start() {
        pc = new RTCPeerConnection();

        if (!stream) {
          stream = await navigator.mediaDevices.getDisplayMedia({
            video: { frameRate: 30, displaySurface: "monitor" },
          });
          // const track = stream.getVideoTracks()[0];
          // console.log(track.getCapabilities());
          // console.log(track.getConstraints());
          // console.log(track.getSettings());
          // await track.applyConstraints({
          // width: { min: 1920, ideal: 1920 },
          // });
        }

        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        const codecs = RTCRtpSender.getCapabilities("video").codecs;
        console.log("available codecs", codecs);

        // for (const tcvr of pc.getTransceivers()) {
        //   tcvr.setCodecPreferences(
        //     codecs.filter((c) => c.mimeType === "video/VP9")
        //   );
        // }

        const offer = await pc.createOffer();
        pc.setLocalDescription(offer);

        pc.addEventListener("icecandidate", (e) => {
          if (e.candidate) {
            console.log("sending ice candidate", e.candidate);
            ws.send("rtc:ice", JSON.stringify(e.candidate));
          }
        });

        console.log("sending offer");
        ws.send("rtc:offer", JSON.stringify(offer));
      }

      ws?.on("rtc:ice", async (data) => {
        const ice = JSON.parse(data);
        console.log("received ice candidate", ice);
        pc.addIceCandidate(new RTCIceCandidate(ice));
      });

      ws?.on("rtc:answer", async (data) => {
        const answer = JSON.parse(data);
        console.log("received answer", answer);
        await pc.setRemoteDescription(answer);
        console.log("connected to peer");
      });

      ws?.on("rtc:connect", start);

      document.querySelector("button").addEventListener("click", start);
    </script>
  </body>
</html>
